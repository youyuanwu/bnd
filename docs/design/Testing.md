# End-to-End Testing

## Goal

Prove the full pipeline works: **C header → bindscrape (winmd) → windows-bindgen
(Rust bindings) → native library → call bindings from Rust tests**.

---

## Architecture

```
tests/fixtures/
├── simple.h / simple.toml   ← single-partition (e2e-simple)
└── multi/                   ← multi-partition  (e2e-multi)
    ├── types.h, widget.h
    └── multi.toml
        │
        ├── bindscrape ──→ .winmd                  (winmd metadata)
        │                        │
        │                  windows-bindgen --sys   (Rust FFI bindings)
        │                        │
        │                        ▼
        │                  */src/bindings.rs
        │
        ├── simple-impl crate ─→ libsimple.so     (Rust cdylib)
        │
        └── #[test] ──→ call generated bindings    (verify round-trip)
```

## Crate Layout

```
tests/
├── simple-impl/          ← cdylib: #[unsafe(no_mangle)] extern "C" fns
│   ├── Cargo.toml
│   └── src/lib.rs
├── e2e-simple/           ← single-partition E2E (simple.h → SimpleTest)
│   ├── Cargo.toml
│   ├── build.rs
│   └── src/
│       ├── lib.rs        ← mod bindings + 6 tests
│       └── bindings.rs   ← generated by build.rs
└── e2e-multi/            ← multi-partition E2E (types.h + widget.h → MultiTest)
    ├── Cargo.toml
    ├── build.rs
    └── src/
        ├── lib.rs        ← mod bindings + cross-partition tests
        └── bindings.rs   ← generated by build.rs
```

Workspace members: `["bindscrape", "tests/simple-impl", "tests/e2e-simple", "tests/e2e-multi"]`

Run:
- Single-partition: `cargo test -p e2e-simple`
- Multi-partition: `cargo test -p e2e-multi`
- All: `cargo test --workspace`

---

## Key Design Decisions

- **cdylib over staticlib**: `staticlib` produces hashed output in `deps/`
  (e.g., `libsimple-<hash>.a`), which doesn't match the `#[link(name = "simple")]`
  emitted by `windows-bindgen`. A `cdylib` produces unhashed `libsimple.so`
  in `target/<profile>/`. Build.rs sets `-L`, `-l`, and `-rpath` explicitly.

- **`mod bindings` over `include!()`**: Generated bindings contain `#![allow(...)]`
  inner attributes which are invalid inside `include!()`. Outputting to
  `src/bindings.rs` and using `mod bindings` avoids this.

- **`simple-impl` is not a cargo dependency**: It's a cdylib linked via
  explicit `cargo:rustc-link-lib=dylib=simple` in build.rs.

- **`[lib] name = "simple"`**: Required so the linker output matches the
  ImplMap `library = "simple"` field in the winmd.

- **`--flat` for single-partition, namespaced for multi**: `e2e-simple` uses
  `--flat` since all types share one namespace. `e2e-multi` omits `--flat`
  to generate nested `pub mod MultiTest::Types` / `MultiTest::Widgets`
  modules, validating cross-partition `super::Types::` references.

- **Multi-header wrapper generation**: When a partition lists multiple
  headers, `wrapper_header()` generates a temp `.c` file with `#include`
  lines — the same pattern win32metadata uses with its scraper `.c` files.

- **Clang singleton**: The `clang` crate only allows one `Clang` instance.
  Roundtrip tests use a single `LazyLock<AllWinmd>` to initialize both
  single- and multi-partition winmds sequentially, avoiding the race.

---

## Generated Binding Shape (`windows-bindgen --sys` v0.66)

| C construct | `--flat` (e2e-simple) | Namespaced (e2e-multi) |
|---|---|---|
| Functions | `windows_link::link!("simple" "C" fn name(...))` | Same, inside `mod Widgets` |
| Structs | `#[repr(C, packed(N))]` with `Clone, Copy, Default` | Same, inside namespace mod |
| Enums | `pub type Color = u32` + `pub const COLOR_RED: u32 = 0` | Same |
| `#define` constants | `pub const MAX_WIDGETS: i32 = 256i32` | Same, inside `mod Types` |
| Delegates (fn ptrs) | `pub type CompareFunc = Option<unsafe extern "system" fn(...)>` | Same |
| `Widget*` params | `*const Widget` (not `*mut`) | Same |
| `const char*` field | `*mut i8` | Same |
| Cross-partition refs | N/A | `super::Types::Color`, `super::Types::Rect` |
| Module structure | All items at top level | `pub mod MultiTest { pub mod Types { ... } pub mod Widgets { ... } }` |

---

## What This Validates

| Layer | Test |
|---|---|
| winmd format | `windows-bindgen` accepts it without error |
| Type mapping | Correct sizes, layouts, field names |
| Enum mapping | Integer values match C definitions |
| P/Invoke / ImplMap | FFI calls dispatch to native lib |
| Constants | Available as Rust consts with correct values |
| Delegates | `CompareFunc` type exists, Rust fn castable to it |
| Struct by value | `Rect` passed by value across FFI |
| Pointer round-trip | `Widget.name` survives create → read back |

---

## Future Work

- **Negative testing**: malformed winmd → verify error messages
- **CI**: ensure libclang available (no C compiler needed)
- **Extend**: unions, bitfields, nested structs as bindscrape supports them

---

## Multi-Partition & Cross-Partition Testing

### Goal

Validate that bindscrape correctly handles multiple partitions (namespaces)
within a single winmd, and that types defined in one partition can be
referenced from another. This exercises the `TypeRegistry` cross-partition
resolution path.

### Fixture Layout

```
tests/fixtures/
├── simple.h       ← single-partition (unchanged)
├── simple.toml
└── multi/         ← multi-partition
    ├── types.h
    ├── widget.h
    └── multi.toml
```

### Test Headers

Split the existing `simple.h` into two headers with a dependency edge:

**`multi/types.h`** — shared types, no functions:
```c
#pragma once

typedef enum {
    COLOR_RED = 0, COLOR_GREEN = 1, COLOR_BLUE = 2,
} Color;

typedef struct {
    int x, y;
    unsigned int width, height;
} Rect;

typedef int (*CompareFunc)(const void* a, const void* b);

#define MAX_WIDGETS 256
#define DEFAULT_WIDTH 800
#define DEFAULT_HEIGHT 600
```

**`multi/widget.h`** — functions that reference types from `types.h`:
```c
#pragma once
#include "types.h"

typedef struct {
    const char* name;
    int values[4];
    Color color;        // ← cross-partition reference to Types.Color
} Widget;

int create_widget(const char* name, Rect bounds, Widget* out);
void destroy_widget(Widget* w);
int widget_count(void);
```

### Config

**`multi/multi.toml`**:
```toml
[output]
name = "MultiTest"
file = "multi_test.winmd"

[[partition]]
namespace = "MultiTest.Types"
library = "simple"
headers = ["types.h"]
traverse = ["types.h"]

[[partition]]
namespace = "MultiTest.Widgets"
library = "simple"
headers = ["types.h", "widget.h"]
traverse = ["widget.h"]
```

Key points:
- `types.h` partition: defines `Color`, `Rect`, `CompareFunc`, constants
  in namespace `MultiTest.Types`
- `widget.h` partition: includes `types.h` for compilation but only
  traverses `widget.h` — emits `Widget`, functions in `MultiTest.Widgets`
- Both partitions share the same `library = "simple"` (same cdylib)

### What This Tests

| Aspect | Verified by |
|---|---|
| **Multi-namespace emission** | winmd contains both `MultiTest.Types` and `MultiTest.Widgets` |
| **Cross-partition TypeRef** | `Widget.color` field resolves to `MultiTest.Types.Color` (not `MultiTest.Widgets.Color`) |
| **Struct from other namespace** | `create_widget` param `Rect bounds` resolves to `MultiTest.Types.Rect` |
| **TypeRegistry resolution** | `registry.namespace_for("Color", ...)` returns `MultiTest.Types` |
| **Traverse filtering** | `types.h` types don't appear in `MultiTest.Widgets` namespace |
| **windows-bindgen accepts it** | `--filter MultiTest` generates bindings for both namespaces |
| **FFI round-trip** | Same native lib works with multi-namespace bindings |

### Implementation Plan

1. **Add test fixtures** — ✅ done
   `tests/fixtures/multi/types.h`, `widget.h`, `multi.toml`
2. **Add roundtrip tests** — ✅ done (5 multi-partition tests in `roundtrip.rs`)
   Verify types land in correct namespaces, traverse filtering, cross-partition TypeRef
3. **Add `tests/e2e-multi/` crate** — ✅ done (8 tests)
   Separate crate with `build.rs` running `multi.toml` through bindscrape →
   `windows-bindgen --filter MultiTest` (no `--flat`), links same cdylib
4. **Native lib** — ✅ same `simple-impl` crate, no changes needed

---

## Status

| Item | Status |
|---|---|
| `tests/simple-impl/` (cdylib, 65 LOC) | ✅ |
| `tests/e2e-simple/` (build.rs + 6 tests, `--flat`) | ✅ |
| `tests/e2e-multi/` (build.rs + 8 tests, namespaced) | ✅ |
| `tests/e2e-zlib/` (build.rs + 12 tests, `--flat`, real libz.so) | ✅ |
| `bns-posix/` (15 tests, package mode, POSIX syscalls) | ✅ |
| `bns-posix-gen/` (generator, `--package` mode) | ✅ |
| Multi-header wrapper generation (`config.rs`) | ✅ |
| Clang singleton fix (`AllWinmd` LazyLock) | ✅ |
| 28 roundtrip + 42 e2e + 2 doc-tests | ✅ **72 passing, 0 warnings** |